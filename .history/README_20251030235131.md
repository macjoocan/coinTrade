# 업비트 자동매매 봇 시스템 로직 문서

> **버전**: 2.0  
> **최종 수정**: 2025-10-30  
> **문서 목적**: 코드 구현이 아닌 의사결정 로직 중심의 시스템 설명

---

## 📑 목차

1. [시스템 개요](#1-시스템-개요)
2. [전체 아키텍처](#2-전체-아키텍처)
3. [거래 의사결정 프로세스](#3-거래-의사결정-프로세스)
4. [신호 생성 로직](#4-신호-생성-로직)
5. [리스크 관리 로직](#5-리스크-관리-로직)
6. [청산 전략](#6-청산-전략)
7. [적응형 전략 시스템](#7-적응형-전략-시스템)
8. [예외 상황 처리](#8-예외-상황-처리)

---

## 1. 시스템 개요

### 1.1 핵심 목표
- **목표 수익률**: 일 1.5% 이상
- **리스크 관리**: 일일 손실 1.5% 제한
- **거래 빈도**: 하루 최대 30회
- **보유 시간**: 최소 30분 (1,800초)

### 1.2 시스템 특징
```
멀티 시그널 통합 → 신호 가중 평균 → 진입 점수 산출 → 리스크 체크 → 거래 실행
         ↓
    실시간 모니터링 → 부분 매도/손절/익절 → 포지션 관리 → 성과 분석
```

### 1.3 3단계 방어선
1. **진입 방어**: 엄격한 신호 검증 (3가지 신호 통합)
2. **보유 방어**: 실시간 손절/익절 모니터링
3. **전략 방어**: 연속 손실 시 자동 보수적 전환

---

## 2. 전체 아키텍처

### 2.1 모듈 구조도

```
┌─────────────────────────────────────────────────────────┐
│                   Main Trading Bot                       │
│                  (거래 실행 엔진)                           │
└─────────────────┬───────────────────────────────────────┘
                  │
        ┌─────────┴──────────┐
        │                    │
   ┌────▼─────┐      ┌──────▼────────┐
   │  신호 생성  │      │   리스크 관리   │
   └────┬─────┘      └──────┬────────┘
        │                    │
   ┌────┴────────────────────┴─────┐
   │                                │
┌──▼──────────┐            ┌───────▼──────┐
│ 전략 시스템   │            │  포지션 관리   │
└──┬──────────┘            └───────┬──────┘
   │                                │
   └────────────┬───────────────────┘
                │
        ┌───────▼──────────┐
        │   기록 & 분석     │
        └──────────────────┘
```

### 2.2 데이터 흐름

```
시장 데이터 수집
    ↓
기술적 지표 계산
    ↓
3가지 신호 생성 (Technical, MTF, ML)
    ↓
가중 평균 점수 산출
    ↓
시장 상황 조정
    ↓
진입 조건 판단
    ↓
포지션 크기 계산 (Kelly Criterion)
    ↓
거래 실행
    ↓
실시간 모니터링 (손절/익절/부분매도)
    ↓
청산 및 기록
```

---

## 3. 거래 의사결정 프로세스

### 3.1 진입 결정 로직

```
┌──────────────────────────────────────┐
│ STEP 1: 사전 조건 검증                 │
├──────────────────────────────────────┤
│ • 일일 거래 한도 체크 (30회)            │
│ • 쿨다운 체크 (동일 코인 30분 간격)      │
│ • 연속 손실 체크 (2회 이상 시 중단)      │
│ • 최대 포지션 수 체크                   │
│ • RSI 과매수 필터 (70 이상 진입 금지)   │
└──────────────────────────────────────┘
           ↓ PASS
┌──────────────────────────────────────┐
│ STEP 2: 신호 점수 계산                 │
├──────────────────────────────────────┤
│ 📊 기술적 분석 (0~1점)                 │
│   - 추세 분석 (이동평균)                │
│   - RSI 분석                          │
│   - MACD 분석                         │
│   - 거래량 분석                        │
│   - 변동성 분석                        │
│                                       │
│ 📈 멀티 타임프레임 분석 (0~1점)          │
│   - 1시간봉 분석                       │
│   - 4시간봉 분석                       │
│   - 일봉 분석                          │
│   - 타임프레임 간 합의도                │
│                                       │
│ 🤖 머신러닝 예측 (0~1점)                │
│   - 랜덤포레스트 매수 확률              │
│   - 신뢰도 평가                        │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ STEP 3: 최종 점수 산출                 │
├──────────────────────────────────────┤
│ 최종점수 = (Tech × W₁) + (MTF × W₂)    │
│          + (ML × W₃)                  │
│                                       │
│ 프리셋별 가중치:                        │
│ • Conservative: 0.25, 0.45, 0.30     │
│ • Balanced: 0.45, 0.40, 0.15         │
│ • Aggressive: 0.80, 0.20, 0.00       │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ STEP 4: 시장 상황 조정                 │
├──────────────────────────────────────┤
│ 시장 분석 (상위 3개 코인 3일 변동률)     │
│ • Bullish: 기준점 -0.0                │
│ • Neutral: 기준점 +0.0                │
│ • Bearish: 기준점 +0.0                │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ STEP 5: 진입 판단                      │
├──────────────────────────────────────┤
│ IF 최종점수 >= 진입기준점               │
│ THEN 진입 승인                         │
│ ELSE 진입 거부                         │
│                                       │
│ 프리셋별 진입 기준:                     │
│ • Conservative: 7.0점                 │
│ • Balanced: 5.5점                     │
│ • Aggressive: 4.5점                   │
└──────────────────────────────────────┘
```

### 3.2 의사결정 트리

```
진입 검토 시작
    │
    ├─ 거래 가능 횟수 남음? ─[NO]→ 거래 중단
    │       │[YES]
    │       ↓
    ├─ 쿨다운 시간 경과? ─[NO]→ 대기
    │       │[YES]
    │       ↓
    ├─ 연속 손실 < 2회? ─[NO]→ 거래 중단
    │       │[YES]
    │       ↓
    ├─ RSI < 70? ─[NO]→ 과매수 대기
    │       │[YES]
    │       ↓
    ├─ 신호 점수 계산
    │       ↓
    ├─ 점수 >= 기준점? ─[NO]→ 진입 거부
    │       │[YES]
    │       ↓
    ├─ 포지션 수 < 최대치? ─[NO]→ 진입 거부
    │       │[YES]
    │       ↓
    └─ ✅ 진입 승인
```

---

## 4. 신호 생성 로직

### 4.1 기술적 분석 신호 (Technical Signal)

#### 점수 구성 (총 12점 만점)

```
1. 추세 분석 (최대 2.5점)
   ├─ 강한 상승: SMA20 > SMA50 AND Price > SMA20 → +2.5점
   ├─ 상승 추세: SMA20 > SMA50 → +1.5점
   └─ 단기 상승: Price > SMA20 → +0.5점

2. RSI 분석 (최대 3.0점)
   ├─ RSI < 30: 과매도 → +1.0점
   ├─ 30 ≤ RSI < 40: 과매도 반등 → +3.0점 ⭐
   ├─ 40 ≤ RSI < 50: 건강한 수준 → +2.5점
   ├─ 50 ≤ RSI < 60: 상승 지속 → +2.0점
   ├─ 60 ≤ RSI < 65: 강세 → +1.5점
   ├─ 65 ≤ RSI < 70: 과매수 주의 → +1.0점
   └─ RSI ≥ 70: 과매수 위험 → +0.0점 (진입 금지)

3. MACD 분석 (최대 2.0점)
   ├─ MACD > Signal AND MACD > 0: 강세 → +2.0점
   ├─ MACD > Signal: 양전환 → +1.5점
   └─ MACD ≈ Signal: 크로스 임박 → +0.5점

4. 거래량 분석 (최대 2.0점)
   ├─ 거래량 > 평균 × 1.5: 급증 → +2.0점
   └─ 거래량 > 평균 × 1.2: 증가 → +1.0점

5. 변동성 분석 (최대 2.0점)
   ├─ 0.01 < 변동성 < 0.02: 안정적 → +2.0점
   └─ 0.02 ≤ 변동성 < 0.025: 보통 → +1.0점
```

#### 로직 예시
```
예시 1: 강한 매수 신호
- 추세: SMA20 > SMA50, Price > SMA20 → +2.5점
- RSI: 45 (건강한 수준) → +2.5점
- MACD: 양전환 확인 → +1.5점
- 거래량: 평균의 1.8배 → +2.0점
- 변동성: 0.015 (안정적) → +2.0점
→ 총점: 10.5/12 → 정규화: 0.875 (87.5%)

예시 2: 약한 신호
- 추세: 횡보 → +0점
- RSI: 68 (과매수 주의) → +1.0점
- MACD: 음봉 → +0점
- 거래량: 평균 수준 → +0점
- 변동성: 0.04 (높음) → +0점
→ 총점: 1.0/12 → 정규화: 0.083 (8.3%)
```

### 4.2 멀티 타임프레임 분석 (MTF Signal)

#### 3개 타임프레임 종합 분석

```
┌─────────────────────────────────────────┐
│ 1시간봉 (가중치 30%)                      │
├─────────────────────────────────────────┤
│ • 단기 추세 파악                          │
│ • 진입 타이밍 포착                        │
│ • 단기 과매수/과매도 확인                  │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 4시간봉 (가중치 40%) ⭐ 가장 중요          │
├─────────────────────────────────────────┤
│ • 중기 추세 방향 결정                      │
│ • 지지/저항 레벨 확인                      │
│ • 추세 강도 평가                          │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 일봉 (가중치 30%)                         │
├─────────────────────────────────────────┤
│ • 장기 추세 확인                          │
│ • 메이저 지지/저항 확인                    │
│ • 전체적인 시장 방향성                     │
└─────────────────────────────────────────┘
```

#### 각 타임프레임별 점수 계산 (0~10점)

```
타임프레임 점수 = 추세점수(0~3) + 추세강도(0~2) 
                + RSI점수(0~2) + MACD점수(0~2) 
                + 거래량점수(0~1)

1. 추세 점수
   ├─ strong_uptrend: +3점
   ├─ uptrend: +2점
   ├─ sideways: +1점
   └─ downtrend: +0점

2. 추세 강도 (20일 방향성 일관도)
   └─ 일관도 × 2 (0~2점)

3. RSI 점수
   ├─ 30 < RSI < 40: +2점
   ├─ 40 < RSI < 50: +1.5점
   └─ 50 < RSI < 60: +1점

4. MACD 점수
   ├─ MACD > Signal AND 히스토그램 > 0: +2점
   └─ MACD > Signal: +1.5점

5. 거래량
   └─ 거래량 증가 추세: +1점
```

#### 타임프레임 합의도 (Consensus)

```
합의 계산:
- 각 타임프레임의 추세 방향을 투표
- 상승 추세 비율 = 상승 투표 수 / 전체 타임프레임

예시:
- 1h: uptrend (가중치 0.3)
- 4h: strong_uptrend (가중치 0.4)
- 1d: sideways (가중치 0.3)

상승 합의도 = (0.3 + 0.4) / 1.0 = 70%

평가:
- 합의도 ≥ 85%: 강한 신호
- 합의도 ≥ 65%: 중간 신호
- 합의도 < 65%: 약한 신호
```

#### 최종 MTF 점수

```
최종 MTF 점수 = Σ(각 타임프레임 점수 × 가중치)

예시:
- 1h: 7.0점 × 0.3 = 2.1
- 4h: 8.5점 × 0.4 = 3.4
- 1d: 6.0점 × 0.3 = 1.8
→ 최종: 7.3/10점

정규화: 7.3/10 = 0.73 (73%)
```

### 4.3 머신러닝 예측 (ML Signal)

#### 학습 데이터 생성 로직

```
1. 데이터 수집
   └─ 2,000개 1시간봉 (약 83일)

2. 특성(Feature) 생성 (총 30개 특성)
   ├─ 가격 특성 (3개): 1h, 4h, 24h 수익률
   ├─ 이동평균 (6개): SMA10/20/50, 가격/SMA 비율
   ├─ 기술적 지표 (6개): RSI, MACD, 신호, 히스토그램
   ├─ 볼린저 밴드 (3개): 상단, 하단, 위치
   ├─ 변동성 (2개): 표준편차, ATR
   ├─ 거래량 (3개): 평균, 비율, 변화율
   ├─ 모멘텀 (2개): 10일, 20일
   ├─ 캔들 패턴 (3개): 몸통, 위꼬리, 아래꼬리
   └─ 시간 특성 (2개): 시간, 요일

3. 레이블(Label) 생성
   └─ 6시간 후 수익률 > 1.5% → 긍정(1)
   └─ 그 외 → 부정(0)

4. 학습
   └─ 랜덤포레스트 (100 트리, 깊이 10)
```

#### 예측 로직

```
실시간 예측:
1. 최신 200개 1시간봉 수집
2. 30개 특성 계산
3. 스케일링 적용
4. 모델 예측
   ├─ 매수 확률: 0~1
   └─ 신뢰도: max(확률)

예시 출력:
{
  'prediction': True,
  'buy_probability': 0.73,    # 73% 상승 예측
  'confidence': 0.73,         # 73% 신뢰도
}

신호 평가:
- 매수 확률 ≥ 75%: 강한 신호 (0.9점)
- 매수 확률 ≥ 50%: 보통 신호 (0.7점)
- 매수 확률 ≥ 25%: 약한 신호 (0.5점)
- 매수 확률 < 25%: 매수 금지 (0.0점)
```

### 4.4 신호 통합 로직

#### 가중 평균 계산

```
프리셋별 가중치:

Conservative (보수적):
├─ Technical: 25%  (단기 신호 낮춤)
├─ MTF: 45%        (장기 추세 중시) ⭐
└─ ML: 30%         (AI 신뢰)

Balanced (균형):
├─ Technical: 45%  (기술적 분석 중시)
├─ MTF: 40%        (추세 확인)
└─ ML: 15%         (보조 지표)

Aggressive (공격적):
├─ Technical: 80%  (단기 신호 최대) ⭐
├─ MTF: 20%        (추세 참고만)
└─ ML: 0%          (비활성화)
```

#### 최종 점수 계산 예시

```
예시: Balanced 프리셋

신호 점수:
- Technical: 0.85 (10.2/12점)
- MTF: 0.73 (7.3/10점)
- ML: 0.60 (60% 확률)

최종 점수 = (0.85 × 0.45) + (0.73 × 0.40) + (0.60 × 0.15)
          = 0.3825 + 0.292 + 0.09
          = 0.7645

10점 스케일: 0.7645 × 10 = 7.645점

시장 조정:
- 현재 시장: Neutral → 조정 없음
- 최종 점수: 7.645점

진입 판단:
- Balanced 기준점: 5.5점
- 7.645 ≥ 5.5 → ✅ 진입 승인
```

---

## 5. 리스크 관리 로직

### 5.1 Kelly Criterion 포지션 사이징

#### 이론적 배경
```
Kelly Fraction = (p × b - q) / b

여기서:
- p = 승률 (Win Rate)
- q = 1 - p (패율)
- b = 평균 수익 / 평균 손실 (손익비)

보수적 적용:
- Kelly × 0.25 (25%만 사용)
- 최소: 1%
- 최대: 10%
```

#### 실전 적용 로직

```
STEP 1: 기본 Kelly 계산
승률 = 6승 / 10거래 = 0.6
손익비 = 평균수익 15,000원 / 평균손실 10,000원 = 1.5

Kelly = (0.6 × 1.5 - 0.4) / 1.5
      = (0.9 - 0.4) / 1.5
      = 0.333 (33.3%)

보수적 Kelly = 0.333 × 0.25 = 0.083 (8.3%)

STEP 2: 최대 제한 적용
포지션 크기 = min(8.3%, 설정 최대값)

프리셋별 최대값:
- Conservative: 15%
- Balanced: 20%
- Aggressive: 50%

→ Balanced: min(8.3%, 20%) = 8.3%

STEP 3: 잔고 계산
잔고: 500,000원
기본 포지션 = 500,000 × 0.083 = 41,500원

STEP 4: 조정 적용
├─ 동적 코인 조정: × 0.6 (60%)
├─ 시장 상황 조정: × 1.0 (Neutral)
├─ 변동성 조정: × 0.9 (높은 변동성)
└─ 연속 손실 조정: × 0.83 (1회 손실)

최종 포지션 = 41,500 × 0.6 × 1.0 × 0.9 × 0.83
            = 18,600원

STEP 5: 최소/최대 제한
- 최소 주문: 5,000원
- 최대 주문: 100,000원 (잔고의 20%)

→ 최종: 18,600원 ✅
```

### 5.2 동적 조정 시스템

#### 조정 요소별 로직

```
1. 코인 유형 조정
   ├─ STABLE_PAIRS (BTC, ETH, SOL, XRP, DOGE, ADA)
   │   └─ 조정 없음 (× 1.0)
   └─ 동적 코인 (모멘텀 스캔)
       └─ 60% 축소 (× 0.6)
       
   이유: 동적 코인은 변동성이 높아 리스크 증가

2. 시장 상황 조정
   ├─ Bullish (상승장)
   │   └─ 10% 확대 (× 1.1)
   ├─ Neutral (횡보)
   │   └─ 조정 없음 (× 1.0)
   └─ Bearish (하락장)
       └─ 30% 축소 (× 0.7)
       
   판단 기준:
   - 상위 3개 코인의 3일 변동률 평균
   - 2개 이상 +3% 이상: Bullish
   - 2개 이상 -3% 이하: Bearish
   - 그 외: Neutral

3. 변동성 조정
   변동성 = ATR / 현재가
   
   조정 배수 = min(1.0, 0.02 / 변동성)
   
   예시:
   - 변동성 0.01 (1%): 0.02/0.01 = 2.0 → 1.0 (최대)
   - 변동성 0.02 (2%): 0.02/0.02 = 1.0 ✅
   - 변동성 0.04 (4%): 0.02/0.04 = 0.5 (50% 축소)
   
   이유: 변동성이 높으면 손실 위험 증가

4. 연속 손실 조정
   조정 배수 = 1.0 / (1 + 연속손실 × 0.2)
   
   예시:
   - 0회 손실: 1.0 / 1.0 = 1.0 (100%)
   - 1회 손실: 1.0 / 1.2 = 0.83 (83%)
   - 2회 손실: 1.0 / 1.4 = 0.71 (71%)
   - 3회 손실: 거래 중단
   
   이유: 연속 손실 시 감정적 판단 가능성 증가
```

### 5.3 리스크 체크 게이트

#### 진입 전 검증

```
┌───────────────────────────────────────┐
│ Gate 1: 일일 손실 한도                  │
├───────────────────────────────────────┤
│ IF 일일 손실 ≥ 초기자본 × 1.5%          │
│ THEN 거래 중단                         │
└───────────────────────────────────────┘
           ↓ PASS
┌───────────────────────────────────────┐
│ Gate 2: 연속 손실 제한                  │
├───────────────────────────────────────┤
│ IF 연속 손실 ≥ 2회                     │
│ THEN 거래 일시 중단                     │
│                                       │
│ 복구 조건:                             │
│ - 1회 수익 발생 → 카운터 -1             │
│ - 시간 경과 (6시간) → 리셋              │
└───────────────────────────────────────┘
           ↓ PASS
┌───────────────────────────────────────┐
│ Gate 3: 최대 포지션 수                  │
├───────────────────────────────────────┤
│ IF 현재 포지션 ≥ 최대 포지션             │
│ THEN 신규 진입 금지                     │
│                                       │
│ 프리셋별 최대값:                        │
│ - Conservative: 2개                   │
│ - Balanced: 5개                       │
│ - Aggressive: 4개                     │
└───────────────────────────────────────┘
           ↓ PASS
┌───────────────────────────────────────┐
│ Gate 4: 자본 보호 제한                  │
├───────────────────────────────────────┤
│ IF 현재 잔고 < 초기자본 × 70%           │
│ THEN 보호 모드 (거래 중단)              │
│                                       │
│ 이유: 30% 손실은 복구가 어려움           │
│ (30% 손실 → 43% 수익 필요)             │
└───────────────────────────────────────┘
           ↓ PASS
┌───────────────────────────────────────┐
│ ✅ 거래 승인                            │
└───────────────────────────────────────┘
```

---

## 6. 청산 전략

### 6.1 청산 우선순위

```
우선순위 1: 손절 (Stop Loss)
    ↓
우선순위 2: 추적 손절 (Trailing Stop)
    ↓
우선순위 3: 부분 매도 (Partial Exit)
    ↓
우선순위 4: 최종 익절 (Take Profit)
```

### 6.2 손절 로직

#### 기본 손절 메커니즘

```
손절 조건:
현재 손실률 ≤ -손절 기준

프리셋별 기준:
- Conservative: -0.8%
- Balanced: -1.0%
- Aggressive: -1.2%

특징:
✅ 보유시간 무시 (즉시 실행)
✅ 최우선 순위
```

#### 물타기 고려 손절

```
물타기 횟수에 따른 손절 확대:

기본 손절: -1.0%

물타기 1회:
└─ 손절 기준: -1.0% + 0.5% = -1.5%

물타기 2회:
└─ 손절 기준: -1.0% + 1.0% = -2.0%

물타기 3회:
└─ 손절 기준: -1.0% + 1.5% = -2.5% (최대)

로직:
adjustment = min(물타기횟수 × 0.5%, 1.5%)
최종손절 = 기본손절 + adjustment

이유:
물타기로 평단이 낮아졌으므로
회복 가능성을 위해 손절 기준 완화
```

#### 손절 실행 흐름

```
1. 손실 감지
   └─ 현재가 < 진입가 × (1 - 손절기준)

2. 물타기 여부 확인
   ├─ 물타기 중 → 손절 기준 확대
   └─ 물타기 완료 → 기본 손절 적용

3. 소액 포지션 체크
   ├─ 현재 가치 < 8,000원
   │   └─ 매도 불가 → 대기
   └─ 현재 가치 ≥ 8,000원
       └─ 매도 실행

4. 강제 손절 실행
   └─ 보유시간 무시, 즉시 시장가 매도

5. 기록 업데이트
   ├─ 연속 손실 카운터 +1
   ├─ 일일 손익 업데이트
   └─ 물타기 기록 삭제
```

### 6.3 추적 손절 로직

#### 수익 보호 메커니즘

```
목적:
- 수익이 발생한 후 하락 시 수익 보호
- 최고가 대비 일정 하락 시 청산

작동 조건:
수익률 ≥ +1.5%

추적 방식:
1. 최고가 지속 업데이트
   현재가 > 기록된 최고가
   → 최고가 = 현재가

2. 하락폭 모니터링
   수익률별 차등 적용:
   
   +2.0% 이상 달성:
   └─ 최고가 대비 -1.0% 하락 허용
      (예: 102원 → 101원 = +1.0% 수익 확보)
   
   +1.5% ~ 2.0% 달성:
   └─ 최고가 대비 -1.0% 하락 허용
      (예: 101.5원 → 100.5원 = +0.5% 수익 확보)
   
   +1.5% 미만:
   └─ 추적 손절 미작동 (최종 익절 대기)

3. 트리거
   IF 현재가 ≤ 최고가 × (1 - 하락허용%)
   THEN 추적 손절 실행
```

#### 추적 손절 vs 물타기 우선순위

```
시나리오: 물타기 진행 중 + 추적 손절 발동

┌─────────────────────────────────────┐
│ 물타기 완료 여부 확인                  │
└───────────┬─────────────────────────┘
            │
    ┌───────┴────────┐
    │                │
 [완료]           [진행 중]
    │                │
    ↓                ↓
추적 손절        추적 손절
   실행            보류
    │                │
    └────────┬───────┘
             ↓
        수익 확보/
        물타기 우선
```

로직:
```python
if 추적손절_발동:
    if 물타기_완료:
        # 추적 손절 실행
        청산("수익 보호")
    else:
        # 물타기 우선
        대기("물타기 기회 유지")
```

### 6.4 부분 매도 전략

#### 3단계 부분 매도

```
목적:
- 수익을 점진적으로 실현
- 추가 상승 기회 유지
- 리스크 단계적 감소

┌──────────────────────────────────────┐
│ 1단계: +1.5% 수익 달성                 │
├──────────────────────────────────────┤
│ 매도 비율: 30%                         │
│ 보유 시간: 30분 이상                    │
│ 결과: 1.5% × 30% = 0.45% 실현         │
│ 잔여: 70% (추가 상승 기대)              │
└──────────────────────────────────────┘
           ↓ 가격 상승
┌──────────────────────────────────────┐
│ 2단계: +2.5% 수익 달성                 │
├──────────────────────────────────────┤
│ 매도 비율: 30% (누적 60%)              │
│ 보유 시간: 즉시                        │
│ 결과: 2.5% × 30% = 0.75% 추가 실현    │
│ 잔여: 40% (더 높은 수익 기대)           │
└──────────────────────────────────────┘
           ↓ 가격 상승
┌──────────────────────────────────────┐
│ 3단계: +4.0% 수익 달성                 │
├──────────────────────────────────────┤
│ 매도 비율: 40% (전량 청산)              │
│ 보유 시간: 즉시                        │
│ 결과: 4.0% × 40% = 1.6% 추가 실현     │
│ 총 실현 수익: 2.8%                     │
└──────────────────────────────────────┘
```

#### 부분 매도 상태 관리

```
상태 추적:
각 포지션별로 실행된 단계 기록

예시:
{
  'BTC': [0, 1],      # 1단계, 2단계 실행 완료
  'ETH': [0],         # 1단계만 실행
  'SOL': []           # 부분 매도 없음
}

청산 시 리셋:
포지션 완전 청산 → 기록 삭제
```

### 6.5 최종 익절

```
조건:
- 수익률 ≥ +1.5%
- 보유시간 ≥ 30분
- 부분 매도 후 남은 수량 전량 청산

실행:
- 잔여 포지션 100% 시장가 매도
- 평균 실현 수익률 기록
- 통계 업데이트 (승률, 손익비)
```

---

## 7. 적응형 전략 시스템

### 7.1 자동 프리셋 전환

#### 전환 의사결정 프로세스

```
┌──────────────────────────────────────┐
│ STEP 1: 시장 데이터 수집 (30분마다)     │
├──────────────────────────────────────┤
│ • 최근 24시간 변동성                   │
│ • 최근 7일 추세 강도                   │
│ • 최근 거래량 추세                     │
│ • 최근 50거래 승률                     │
│ • 연속 손익 패턴                       │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ STEP 2: 시장 상황 평가                 │
├──────────────────────────────────────┤
│ 변동성 수준:                           │
│ • High (≥4%): -2점                   │
│ • Medium (2~4%): 0점                 │
│ • Low (<2%): +1점                    │
│                                      │
│ 추세 강도:                             │
│ • Strong (>70%): +2점                │
│ • Weak (<30%): -1점                  │
│                                      │
│ 거래량:                                │
│ • Increasing (>60%): +1점            │
│                                      │
│ 승률:                                  │
│ • High (≥65%): +2점                  │
│ • Low (≤50%): -2점                   │
│                                      │
│ 연속 결과:                             │
│ • 3회 연속 손실: -3점                  │
│ • 3회 연속 수익: +2점                  │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ STEP 3: 프리셋 추천                    │
├──────────────────────────────────────┤
│ 총점 ≥ +3: Aggressive                │
│ -3 < 총점 < +3: Balanced             │
│ 총점 ≤ -3: Conservative              │
│                                      │
│ 신뢰도 = min(|총점| / 5, 1.0)         │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ STEP 4: 전환 조건 확인                 │
├──────────────────────────────────────┤
│ • 신뢰도 ≥ 60%                        │
│ • 마지막 전환 이후 30분 경과            │
│ • 추천 프리셋 ≠ 현재 프리셋             │
└──────────────────────────────────────┘
           ↓ 조건 충족
┌──────────────────────────────────────┐
│ STEP 5: 프리셋 전환 실행               │
├──────────────────────────────────────┤
│ • config.ACTIVE_PRESET 변경           │
│ • apply_preset() 호출                │
│ • 전략 파라미터 재설정                  │
│ • 로그 기록                            │
└──────────────────────────────────────┘
```

#### 강제 전환 트리거

```
즉시 Conservative 전환 조건:
┌─────────────────────────────────────┐
│ • 연속 2회 손실                       │
│ OR                                  │
│ • 일일 손실률 ≥ 1.5%                 │
│ OR                                  │
│ • 시장 변동성 ≥ 5%                   │
└─────────────────────────────────────┘
           ↓
    즉시 전환 실행
    (대기시간 무시)

즉시 Balanced 복귀 조건:
┌─────────────────────────────────────┐
│ • Conservative 모드에서                │
│ • 2회 연속 손실 해소                  │
│ • 1회 수익 발생                       │
└─────────────────────────────────────┘
```

### 7.2 모멘텀 스캔 (동적 코인)

#### 목적
```
- 고정 코인(BTC, ETH, SOL 등) 외에
- 시장에서 강한 모멘텀을 보이는 코인 발굴
- 단기 수익 기회 확대
```

#### 스캔 로직

```
┌──────────────────────────────────────┐
│ STEP 1: 전체 원화 마켓 조회            │
├──────────────────────────────────────┤
│ • 상위 50개 코인 선택                  │
│ • 스테이블코인 제외                    │
│ • 이미 STABLE_PAIRS인 코인 제외        │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ STEP 2: 코인별 모멘텀 점수 계산         │
├──────────────────────────────────────┤
│ 24시간 변동률 (+2% 이상)               │
│ • ≥ +5%: 매우 강함                    │
│ • ≥ +3%: 강함                        │
│ • ≥ +2%: 보통                        │
│                                      │
│ 거래량 (300억 이상)                    │
│ • ≥ 500억: 높음                      │
│ • ≥ 400억: 보통                      │
│ • ≥ 300억: 최소                      │
│                                      │
│ 변동성 (7% 이하)                       │
│ • < 3%: 안정적                        │
│ • 3~5%: 보통                         │
│ • 5~7%: 높음                         │
│                                      │
│ 모멘텀 점수 (4점 이상)                 │
│ ├─ 연속 상승: 최대 3점                 │
│ ├─ 거래량 증가: 최대 2점               │
│ ├─ 양봉 강도: 최대 3점                 │
│ └─ 고점 갱신: 최대 2점                 │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ STEP 3: 상위 2개 선택                  │
├──────────────────────────────────────┤
│ • 최종 점수 = 변동률 + 모멘텀 점수      │
│ • 내림차순 정렬                        │
│ • Top 2 선택                          │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ STEP 4: 거래 대상 업데이트              │
├──────────────────────────────────────┤
│ TRADING_PAIRS =                      │
│   STABLE_PAIRS + 동적코인             │
│                                      │
│ 예시:                                 │
│ [BTC, ETH, SOL, XRP, DOGE, ADA]     │
│ + [PEPE, SHIB]                      │
└──────────────────────────────────────┘
```

#### 동적 코인 포지션 관리

```
리스크 관리:
- 동적 코인은 포지션 크기 60% 축소
- 최대 2개만 추가
- 6시간마다 재스캔

모멘텀 상실 시:
- 다음 스캔에서 제외되면
- 해당 포지션 즉시 청산
- 안전하게 이탈
```

---

## 8. 예외 상황 처리

### 8.1 물타기 (Averaging Down)

#### 실행 로직

```
┌──────────────────────────────────────┐
│ 목적: 평균 단가 낮춰 손실 회복 용이    │
└──────────────────────────────────────┘

트리거 조건:
1. 손실률 ≤ -1.2%
2. 안정 코인 (선택사항)
3. 약세장 아님 (선택사항)
4. 물타기 횟수 < 3회
5. 총 손실 > -5%
6. 잔고 충분 (잔고의 30% 이상 필요)

실행 결정:
IF 현재 손실률 ≤ 트리거 손실률
THEN 물타기 실행

물타기 금액:
- 원래 포지션과 동일한 금액
- 예: 10,000원 진입 → 10,000원 추가

효과:
진입가: 100원 (수량 100개, 10,000원)
손실: -1.2% → 98.8원
물타기: 98.8원 (수량 101개, 10,000원)

새 평균가: (100×100 + 98.8×101) / 201
         = 99.39원

회복 필요 상승률:
- 기존: (100 - 98.8) / 98.8 = +1.2%
- 물타기 후: (99.39 - 98.8) / 98.8 = +0.6%
→ 회복이 2배 쉬워짐!
```

#### 연쇄 물타기

```
1차 물타기: -1.2%
├─ 진입: 100원 (10,000원)
├─ 물타기: 98.8원 (10,000원)
└─ 평균: 99.4원

2차 물타기: -2.4% (마지막 물타기 대비 -1.2%)
├─ 진입: 99.4원 (기존 평균)
├─ 물타기: 97.6원 (10,000원)
└─ 새 평균: 98.5원

3차 물타기: -3.6% (마지막 물타기 대비 -1.2%)
├─ 진입: 98.5원
├─ 물타기: 96.4원 (10,000원)
└─ 최종 평균: 97.6원

한계:
- 최대 3회까지만
- 총 투자금: 40,000원
- 총 손실 -5% 초과 시 중단
```

#### 물타기 vs 손절 우선순위

```
시나리오: 물타기 진행 중 손절 조건 도달

┌─────────────────────────────────────┐
│ 물타기 완료 여부 확인                  │
└───────────┬─────────────────────────┘
            │
    ┌───────┴────────┐
    │                │
 [완료]           [진행 중]
    │                │
    ↓                ↓
 손절 실행      손절 기준 확대
    │                │
    │           ┌────┴────┐
    │           │         │
    │      [기준 내]  [기준 초과]
    │           │         │
    │           ↓         ↓
    │        대기     손절 실행
    │           │         │
    └───────────┴─────────┘
```

### 8.2 소액 포지션 문제

#### 문제 상황
```
업비트 최소 주문 금액: 5,000원
최소 매도 가능 금액: 약 8,000원

문제:
1. 손실로 포지션 가치 ↓
2. 5,000원 미만 → 물타기 불가
3. 8,000원 미만 → 매도 불가
→ 갇힘!
```

#### 해결 전략

```
감지:
매 사이클마다 포지션 가치 계산
IF 포지션 가치 < 8,000원
THEN 소액 포지션으로 분류

대응:
1. 손절 시도 중단
   └─ 매도 불가능이므로 무의미

2. 10분마다 경고 로그
   └─ "소액 포지션 (5,234원 < 8,000원)"
   └─ "→ 매도 불가, 가격 상승 대기 중..."

3. 가격 상승 대기
   └─ 자동으로 8,000원 이상 회복 모니터링
   └─ 회복 시 정상 청산 로직 재개

4. 추가 물타기 금지
   └─ 소액이라도 물타기는 가능하지만
   └─ 리스크 확대 방지를 위해 중단
```

### 8.3 네트워크 오류 처리

#### API 호출 실패

```
재시도 로직:
1차 실패 → 1초 대기 → 재시도
2차 실패 → 3초 대기 → 재시도
3차 실패 → 오류 로그 → 건너뛰기

중요 작업 (매수/매도):
- 최대 5회 재시도
- 실패 시 관리자 알림 (로그)
- 포지션 상태 보존
```

#### 가격 정보 없음

```
IF 현재가 조회 실패
THEN
  - 해당 코인 분석 건너뛰기
  - 포지션은 유지
  - 다음 사이클에서 재시도
```

### 8.4 봇 재시작 시 복구

#### 포지션 복구 프로세스

```
┌──────────────────────────────────────┐
│ 1. 파일에서 저장된 포지션 로드          │
├──────────────────────────────────────┤
│ active_positions.json:                │
│ {                                     │
│   'BTC': {                            │
│     'entry_price': 95000000,         │
│     'quantity': 0.0001,              │
│     'entry_time': '2025-01-15...'    │
│   }                                   │
│ }                                     │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ 2. 업비트 실제 잔고 조회                │
├──────────────────────────────────────┤
│ upbit.get_balances():                 │
│ [                                     │
│   {                                   │
│     'currency': 'BTC',               │
│     'balance': 0.0001,               │
│     'avg_buy_price': 95500000        │
│   }                                   │
│ ]                                     │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ 3. 포지션 매칭 및 복구                  │
├──────────────────────────────────────┤
│ IF 파일에 있고 잔고에도 있음:           │
│   → 파일의 진입가 사용 (더 정확)        │
│                                      │
│ IF 파일에 없고 잔고에만 있음:           │
│   → 평균 매수가 사용 (업비트 제공)      │
│   → 진입 시간은 현재 시각              │
│   → ⚠️ 경고 로그 출력                 │
│                                      │
│ IF 파일에 있고 잔고에 없음:             │
│   → 이미 청산된 것으로 간주            │
│   → 파일 기록 무시                     │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ 4. 리스크 매니저에 등록                 │
├──────────────────────────────────────┤
│ risk_manager.positions[symbol] = {    │
│   'entry_price': ...,                │
│   'quantity': ...,                   │
│   'value': ...,                      │
│   'entry_time': ...,                 │
│   'highest_price': entry_price       │
│ }                                     │
└──────────────────────────────────────┘
           ↓
┌──────────────────────────────────────┐
│ 5. 정상 모니터링 시작                   │
└──────────────────────────────────────┘
```

### 8.5 긴급 상황 대응

#### 자동 보호 모드

```
트리거 조건:
┌─────────────────────────────────────┐
│ • 연속 4회 손실                       │
│ OR                                  │
│ • 일일 손실 3% 초과                   │
│ OR                                  │
│ • 자본 30% 손실                      │
│ OR                                  │
│ • 시스템 오류 연속 발생                │
└─────────────────────────────────────┘
           ↓
      즉시 조치:
1. 모든 신규 진입 중단
2. 기존 포지션 유지 (손절만 작동)
3. 관리자에게 알림 (로그)
4. 30분 후 자동 재개

수동 복구:
- 봇 재시작
- 설정 점검
- 프리셋 변경
```

---

## 📝 부록: 용어 정리

### 기술 용어
- **RSI (Relative Strength Index)**: 상대강도지수, 과매수/과매도 판단
- **MACD**: 이동평균 수렴/확산, 추세 전환 포착
- **ATR (Average True Range)**: 평균 진폭, 변동성 측정
- **Kelly Criterion**: 최적 포지션 크기 계산 공식

### 전략 용어
- **물타기 (Averaging Down)**: 하락 시 추가 매수로 평단 낮추기
- **추매 (Pyramiding)**: 상승 시 추가 매수로 수익 확대
- **추적 손절 (Trailing Stop)**: 최고가 대비 일정 하락 시 청산
- **부분 매도 (Partial Exit)**: 수익을 단계적으로 실현

### 리스크 용어
- **손익비**: 평균 수익 / 평균 손실
- **승률**: 수익 거래 / 전체 거래
- **최대 낙폭 (MDD)**: 최고점 대비 최저점까지의 하락률
- **연속 손실**: 손실 거래가 연속으로 발생한 횟수

---

## 🎯 마무리

본 문서는 업비트 자동매매 봇의 **로직과 의사결정 과정**을 중심으로 작성되었습니다.

### 핵심 철학
1. **다층 방어**: 진입 → 보유 → 청산 각 단계에서 리스크 검증
2. **적응성**: 시장 상황과 성과에 따라 전략 자동 조정
3. **투명성**: 모든 의사결정 과정을 로그로 기록
4. **안전성**: 최악의 상황에도 자본 보호 우선

### 개선 방향
- [ ] ML 모델 성능 향상
- [ ] 더 정교한 타이밍 알고리즘
- [ ] 백테스팅 시스템 구축
- [ ] 실시간 대시보드 개선

---

**문서 버전**: 2.0  
**작성일**: 2025-10-30  
**다음 업데이트**: 주요 로직 변경 시